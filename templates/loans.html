<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Page</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>Loan Management</h1>

    <form id="addLoanForm">
        <label for="loanDate">Loan Date:</label>
        <input type="date" id="loanDate" required>

        <label for="bookId">Select Book:</label>
        <select id="bookId" required>
        </select>

        <label for="customerId">Select Customer:</label>
        <select id="customerId" required>
        </select>

        <button type="submit">Create Loan</button>
    </form>

    <div id="loanList"></div>


    <script>
        async function fetchLoans() {
            try {
                const response = await axios.get('http://127.0.0.1:5000/loans');
                renderLoans(response.data);
            } catch (error) {
                console.error('Error fetching loans:', error);
            }
        }

        function renderLoans(response) {
            const loanList = document.getElementById('loanList');
            loanList.innerHTML = '';

            if (response && Array.isArray(response.loans)) {
                response.loans.forEach(loan => {
                    const loanDiv = document.createElement('div');
                    loanDiv.innerHTML = `
                        <strong>Loan Date:</strong> ${loan.loanDate},
                        <strong>Book ID:</strong> ${loan.bookID},
                        <strong>Customer ID:</strong> ${loan.customerID},
                        <strong>Return Date:</strong> ${loan.returnDate || 'N/A'}
                        <button type="button" onclick="updateLoan(${loan.loanID})">Update</button>
                        <button type="button" onclick="deleteLoan(${loan.loanID})">Delete</button>`;
                    loanList.appendChild(loanDiv);
                });
            } else {
                console.error('Error: The fetched data does not contain an array of loans:', response);

            }
        }
        async function updateLoan(loanId) {
            // Fetch existing loan details (unchanged)
            const existingLoanResponse = await axios.get(`http://127.0.0.1:5000/loans/${loanId}`);
            const existingLoan = existingLoanResponse.data;

            if (!existingLoan) {
                console.error(`No loan found with ID: ${loanId}`);
                return;
            }

            // Create a form to gather updated values
            const form = document.createElement('form');

            const updatedLoanDateLabel = document.createElement('label');
            updatedLoanDateLabel.textContent = 'Updated Loan Date:';
            form.appendChild(updatedLoanDateLabel);

            const updatedLoanDateInput = document.createElement('input');
            updatedLoanDateInput.type = 'date';
            updatedLoanDateInput.value = existingLoan.loanDate;
            form.appendChild(updatedLoanDateInput);

            const updatedBookIdLabel = document.createElement('label');
            updatedBookIdLabel.textContent = 'Updated Book ID:';
            form.appendChild(updatedBookIdLabel);

            const updatedBookIdInput = document.createElement('input');
            updatedBookIdInput.type = 'number';
            updatedBookIdInput.value = existingLoan.bookID;
            form.appendChild(updatedBookIdInput);

            const updatedCustomerIdLabel = document.createElement('label');
            updatedCustomerIdLabel.textContent = 'Updated Customer ID:';
            form.appendChild(updatedCustomerIdLabel);

            const updatedCustomerIdInput = document.createElement('input');
            updatedCustomerIdInput.type = 'number';
            updatedCustomerIdInput.value = existingLoan.customerID;
            form.appendChild(updatedCustomerIdInput);

            const updateButton = document.createElement('button');
            updateButton.type = 'button';
            updateButton.textContent = 'Update Loan';

            updateButton.addEventListener('click', async () => {
                const updatedLoanData = {
                    loanDate: updatedLoanDateInput.value,
                    bookID: updatedBookIdInput.value,
                    customerID: updatedCustomerIdInput.value
                };

                try {
                    // Update the loan with the new values
                    const response = await axios.put(`http://127.0.0.1:5000/loans/${loanId}`, updatedLoanData);

                    // Check if the update was successful before displaying the success message
                    if (response.status === 200) {
                        console.log('Loan updated successfully:', response.data);
                        // Display the updated data in the UI
                        renderLoans(response.data);
                    } else {
                        console.error('Error updating loan:', response.data);
                    }
                } catch (error) {
                    console.error('Error updating loan:', error.response ? error.response.data : error.message);
                }

                // Remove the form after updating
                form.remove();
            });

            form.appendChild(updateButton);

            // Add the form to the document
            document.body.appendChild(form);
        }

        async function deleteLoan(loanId) {
            try {
                const confirmDelete = confirm('Are you sure you want to delete this loan?');
                if (confirmDelete) {
                    const response = await axios.delete(`http://127.0.0.1:5000/loans/${loanId}`);
                    console.log('Loan deleted successfully:', response.data);
                    await fetchLoans();
                }
            } catch (error) {
                console.error('Error deleting loan:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            fetchLoans();
        });

        document.getElementById('addLoanForm').addEventListener('submit', function (event) {
            event.preventDefault();
            createLoan();
        });

        async function createLoan() {
            const loanDate = document.getElementById('loanDate').value;
            const bookId = document.getElementById('bookId').value;
            const customerId = document.getElementById('customerId').value;

            try {
                const bookResponse = await axios.get(`http://127.0.0.1:5000/books/${bookId}`);
                const loanType = bookResponse.data.loan_type;

                const loanResponse = await axios.post('http://127.0.0.1:5000/loans', {
                    loanDate: loanDate,
                    bookID: bookId,
                    customerID: customerId,
                    loanType: loanType
                });

                await fetchLoans();
                console.log('Loan created successfully!');
            } catch (error) {
                console.error('Error creating loan:', error);
            }
        }

        async function fetchBooks() {
            try {
                const response = await axios.get('http://127.0.0.1:5000/books');
                renderDropdownOptions('bookId', response.data, 'title');
            } catch (error) {
                console.error('Error fetching books:', error);
            }
        }

        async function fetchCustomers() {
            try {
                const response = await axios.get('http://127.0.0.1:5000/customers');
                renderDropdownOptions('customerId', response.data, 'name');
            } catch (error) {
                console.error('Error fetching customers:', error);
            }
        }

        function renderDropdownOptions(selectId, data, property) {
            const selectElement = document.getElementById(selectId);
            selectElement.innerHTML = '';

            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.text = item[property];
                selectElement.add(option);
            });
        }

        fetchBooks();
        fetchCustomers();
    </script>
</body>
</html>
