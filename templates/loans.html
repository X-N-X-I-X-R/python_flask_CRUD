<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Page</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <h1>Loan Management</h1>

    <!-- Form for adding a loan -->
    <form id="addLoanForm">
        <label for="loanDate">Loan Date:</label>
        <input type="date" id="loanDate" required>

        <label for="bookId">Select Book:</label>
        <select id="bookId" required>
            <!-- Books will be dynamically populated here -->
        </select>

        <label for="customerId">Select Customer:</label>
        <select id="customerId" required>
            <!-- Customers will be dynamically populated here -->
        </select>

        <button type="submit">Create Loan</button>
    </form>

    <div id="loanList"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Fetch books and customers and render them on page load
            fetchBooks();
            fetchCustomers();

            // Add event listener for the form submission
            document.getElementById('addLoanForm').addEventListener('submit', function (event) {
                event.preventDefault();
                createLoan();
            });

            async function fetchBooks() {
    try {
        const response = await axios.get('http://127.0.0.1:5000/books');
        console.log('Books Response:', response.data); // Log the response
        renderDropdownOptions('bookId', response.data, 'title');
    } catch (error) {
        console.error('Error fetching books:', error);
    }
}

// Function to fetch customers from the Flask API
async function fetchCustomers() {
    try {
        const response = await axios.get('http://127.0.0.1:5000/customers');
        console.log('Customers Response:', response.data); // Log the response
        renderDropdownOptions('customerId', response.data, 'name');
    } catch (error) {
        console.error('Error fetching customers:', error);
    }
}



function renderDropdownOptions(selectId, data, property) {
    const selectElement = document.getElementById(selectId);
    selectElement.innerHTML = '';

    data.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id;  // Use item.id directly
        option.text = item[property];
        selectElement.add(option);
    });
}



            // Function to create a loan
            async function createLoan() {
                const loanDate = document.getElementById('loanDate').value;
                const bookId = document.getElementById('bookId').value;
                const customerId = document.getElementById('customerId').value;

                try {
                    // Fetch the selected book to get loan_type
                    const bookResponse = await axios.get(`http://127.0.0.1:5000/books/${bookId}`);
                    const loanType = bookResponse.data.loan_type;

                    // Create a loan with the loan_type information
                    const loanResponse = await axios.post('http://127.0.0.1:5000/loans', {
                        loanDate: loanDate,
                        bookID: bookId,
                        customerID: customerId,
                        loanType: loanType
                    });

                    // Loan created successfully, update the UI
                    await fetchLoans();
                    console.log('Loan created successfully!');
                } catch (error) {
                    console.error('Error creating loan:', error);
                }
            }

            // Function to fetch loans and render them on the page
            async function fetchLoans() {
                try {
                    const response = await axios.get('http://127.0.0.1:5000/loans');
                    renderLoans(response.data);
                } catch (error) {
                    console.error('Error fetching loans:', error);
                }
            }

            // Function to render loans on the page
            function renderLoans(response) {
                const loanList = document.getElementById('loanList');
                loanList.innerHTML = ''; // Clear previous content

                // Ensure that the response data has a 'loans' property and it is an array
                if (response && Array.isArray(response.loans)) {
                    response.loans.forEach(loan => {
                        const loanDiv = document.createElement('div');
                        loanDiv.innerHTML = `<strong>Loan Date:</strong> ${loan.loanDate}, <strong>Book ID:</strong> ${loan.bookID}, <strong>Customer ID:</strong> ${loan.customerID}, <strong>Return Date:</strong> ${loan.returnDate}`;
                        loanList.appendChild(loanDiv);
                    });
                } else {
                    console.error('Error: The fetched data does not contain an array of loans:', response);
                }
            }

            // Fetch loans and render them on page load
            fetchLoans();
        });
    </script>
</body>
</html>